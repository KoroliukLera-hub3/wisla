---
import content from '../../data/reviews.json';
import 'swiper/css';
import 'swiper/css/navigation';
import 'swiper/css/effect-fade';

const icons = {
  quote: `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="currentColor"><path d="M14.017 21L14.017 18C14.017 16.8954 14.9124 16 16.017 16H19.017C19.5693 16 20.017 15.5523 20.017 15V9C20.017 8.44772 19.5693 8 19.017 8H15.017C14.4647 8 14.017 7.55228 14.017 7V3H19.017C20.6739 3 22.017 4.34315 22.017 6V15C22.017 16.6569 20.6739 18 19.017 18H16.017V21H14.017ZM5.0166 21L5.0166 18C5.0166 16.8954 5.91203 16 7.0166 16H10.0166C10.5689 16 11.0166 15.5523 11.0166 15V9C11.0166 8.44772 10.5689 8 10.0166 8H6.0166C5.46432 8 5.0166 7.55228 5.0166 7V3H10.0166C11.6735 3 13.0166 4.34315 13.0166 6V15C13.0166 16.6569 11.6735 18 10.0166 18H7.0166V21H5.0166Z" /></svg>`,
  arrowLeft: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" /></svg>`,
  arrowRight: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" /></svg>`,
  star: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.007 5.404.433c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.433 2.082-5.006z" clip-rule="evenodd" /></svg>`
};

const reviewImages = [
  "/images/reviews/anna.webp",
  "/images/reviews/marek-ewa.webp",
  "/images/reviews/tomasz.webp",
  "/images/reviews/piotr.webp",
  "/images/reviews/karolina.webp"
];
---

<section class="py-24 bg-surface overflow-hidden border-t border-gray-100">
  <div class="container-main">
    
    <div class="text-center mb-16 md:mb-24">
      <span class="text-accent text-xs font-bold uppercase tracking-[0.25em] block mb-4">{content.subheading}</span>
      <h2 class="font-serif text-4xl md:text-5xl lg:text-6xl text-primary">{content.heading}</h2>
    </div>

    <div class="relative flex items-center justify-center gap-8 lg:gap-16">
      
      <button id="reviews-prev" class="hidden md:flex items-center justify-center w-16 h-16 border border-primary text-primary hover:bg-surface hover:border-accent hover:text-accent transition-all duration-300 flex-shrink-0 z-10 group cursor-pointer" aria-label="Poprzednia opinia">
        <div class="w-6 h-6 group-hover:-translate-x-1 transition-transform" set:html={icons.arrowLeft} />
      </button>

      <div class="swiper reviews-swiper w-full max-w-5xl opacity-0 transition-opacity duration-500">
        <div class="swiper-wrapper">
          {content.reviews.map((review, index) => (
            <div class="swiper-slide">
              <div class="flex flex-col md:flex-row items-center gap-10 md:gap-16 px-4 py-8">
                
                <div class="relative flex-shrink-0">
                  <div class="absolute -bottom-6 -left-6 w-full h-full bg-accent -z-10 opacity-20"></div>
                  <div class="relative w-[280px] h-[350px] md:w-[320px] md:h-[400px] bg-gray-200 overflow-hidden shadow-2xl">
                    <img 
                      src={reviewImages[index % reviewImages.length]} 
                      alt={review.author} 
                      width="320"
                      height="400"
                      class="w-full h-full object-cover transition-transform duration-1000 hover:scale-105"
                      loading="lazy"
                    />
                  </div>
                </div>

                <div class="flex-grow text-center md:text-left">
                  <div class="text-accent mb-8 inline-block md:block opacity-30">
                    <div class="w-10 h-10" set:html={icons.quote} />
                  </div>

                  <blockquote class="font-serif text-xl md:text-2xl lg:text-3xl text-primary leading-relaxed mb-8 italic">
                    "{review.text}"
                  </blockquote>

                  <div class="flex justify-center md:justify-start gap-1 mb-6 text-[#FBBF24]">
                    {[...Array(Math.floor(review.rating))].map(() => (
                      <div class="w-5 h-5" set:html={icons.star} />
                    ))}
                  </div>

                  <div>
                    <h4 class="font-bold text-xl text-primary tracking-tight">{review.author}</h4>
                    <p class="text-[10px] text-gray-500 uppercase tracking-[0.3em] mt-2 font-bold">{review.role}</p>
                  </div>
                </div>

              </div>
            </div>
          ))}
        </div>
      </div>

      <button id="reviews-next" class="hidden md:flex items-center justify-center w-16 h-16 border border-primary text-primary hover:bg-surface hover:border-accent hover:text-accent transition-all duration-300 flex-shrink-0 z-10 group cursor-pointer" aria-label="Następna opinia">
        <div class="w-6 h-6 group-hover:translate-x-1 transition-transform" set:html={icons.arrowRight} />
      </button>

    </div>

    <div class="flex md:hidden justify-center gap-6 mt-12">
       <button id="reviews-prev-mob" class="w-14 h-14 border border-primary flex items-center justify-center text-primary active:scale-95 transition-transform" aria-label="Poprzednia">
          <div class="w-5 h-5" set:html={icons.arrowLeft} />
       </button>
       <button id="reviews-next-mob" class="w-14 h-14 border border-accent text-accent flex items-center justify-center active:scale-95 transition-transform" aria-label="Następna">
          <div class="w-5 h-5" set:html={icons.arrowRight} />
       </button>
    </div>

  </div>
</section>

<script>
  import Swiper from 'swiper';
  import { Navigation, Autoplay, EffectFade } from 'swiper/modules';

  const initSwiper = () => {
    // Ждем один кадр анимации перед инициализацией, чтобы DOM "успокоился"
    requestAnimationFrame(() => {
      const swiperEl = document.querySelector('.reviews-swiper');
      if (!swiperEl) return;

      const swiper = new Swiper('.reviews-swiper', {
        modules: [Navigation, Autoplay, EffectFade],
        observer: true,
        observeParents: true,
        slidesPerView: 1,
        spaceBetween: 40,
        loop: true,
        effect: 'fade',
        fadeEffect: { crossFade: true },
        speed: 800,
        autoplay: {
          delay: 8000,
          disableOnInteraction: true,
        },
        navigation: {
          nextEl: '#reviews-next, #reviews-next-mob',
          prevEl: '#reviews-prev, #reviews-prev-mob',
        },
      });

      // Показываем слайдер плавно после инициализации
      swiperEl.classList.remove('opacity-0');
    });
  };

  // Инициализируем только при полной загрузке, чтобы не вызывать Layout Thrashing
  if (document.readyState === 'complete') {
    initSwiper();
  } else {
    window.addEventListener('load', initSwiper);
  }
</script>